

<!DOCTYPE html>
<html lang="en" >

<head>

  <meta charset="UTF-8">
  
<link rel="apple-touch-icon" type="image/png" href="https://cpwebassets.codepen.io/assets/favicon/apple-touch-icon-5ae1a0698dcc2402e9712f7d01ed509a57814f994c660df9f7a952f3060705ee.png" />
<meta name="apple-mobile-web-app-title" content="CodePen">

<link rel="shortcut icon" type="image/x-icon" href="https://cpwebassets.codepen.io/assets/favicon/favicon-aec34940fbc1a6e787974dcd360f2c6b63348d4b1f4e06c77743096d55480f33.ico" />

<link rel="mask-icon" type="" href="https://cpwebassets.codepen.io/assets/favicon/logo-pin-8f3771b1072e3c38bd662872f6b673a722f4b3ca2421637d5596661b4e2132cc.svg" color="#111" />


  <title>CodePen - アメダス_v01</title>
  
  
  
  
<style>
html,
body{
  height: 100%;

}

#mainDiv {
  height: 100%;
  display: flex;
  flex-direction: row;
}

#headerDiv {
  width: 30%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

#viewDiv {
  width: 70%;
  display: flex;
  flex-direction: row;
  overflow: hidden;
}

h2 {
  font-size: 14px;
  margin-bottom: 0px;
}

.dropdown {
  position: relative;
  display:block;
  width: 100%;
  min-height:20px;
  font-size: 16px;
  align-items:center;
  overflow:hidden;
  white-space:nowrap;
}

.hidden {
  display:none;
}

#yearselector{
  width: 90%;
  height: 50px;
}


#graphDiv {
  height: 50%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.chart-panel {
  display: flex;
  flex-wrap: wrap; 
  flex-direction: column;
  height: 100%;
  width: 100%;
  align-content: left;
  padding: 0px;
}

.esri-widget {
  font-size: 12px !important;
}

.esri-ui-corner .esri-expand .esri-widget--panel, .esri-ui-corner .esri-expand .esri-widget--panel-height-only, .esri-ui-corner .esri-component>.esri-widget--panel, .esri-ui-corner .esri-component.esri-widget--panel {
  width: 200px !important;
}

.esri-popup__inline-actions-container:only-child>.esri-popup__action, .esri-popup__inline-actions-container:only-child>.esri-popup__action-toggle {
  max-width: 30% !important;
}

.button {
  height: 25px;
  width: 220px;
}
</style>

  
  
  
  

</head>

<body translate="no" >
  <html>
  <head>
    <meta charset="utf-8" />
    <meta
          name="viewport"
          content="initial-scale=1,maximum-scale=1,user-scalable=no"
          />
    <title>S8</title>

    <link
          rel="stylesheet"
          href="https://js.arcgis.com/4.18/esri/themes/light/main.css"
          />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://js.arcgis.com/4.18/"></script>
    
  </head>

  <body>
    <div id="mainDiv">
      <div id="headerDiv">
        <h2>指標</h2>
        <div class="dropdown"> 
          <select id="bunruiselector">
            <option value="年間値">年間値</option>
            <option value="月別値">月別値</option>
          </select>
        </div>
        <div class="dropdown"> 
          <select id="shihyoselector">
            <option value="年平均気温">年平均気温(℃)</option>
          </select>
        </div>
        <h2>観測年</h2>
        <div id="yearselector" class="slider"></div>
        <div id="monthselectorDiv" class="dropdown hidden"> 
          <h2>月</h2>
          <select id="monthselector">
            <option value="1">1月</option>
            <option value="2">2月</option>
            <option value="3">3月</option>
            <option value="4">4月</option>
            <option value="5">5月</option>
            <option value="6">6月</option>
            <option value="7">7月</option>
            <option value="8">8月</option>
            <option value="9">9月</option>
            <option value="10">10月</option>
            <option value="11">11月</option>
            <option value="12">12月</option>
          </select>
        </div>
        <h2>観測所選択</h2>
        <div class="dropdown"> 
          <select id="prefectureselector">
            <option value="全国">全国</option>
          </select>
          <select id="observatoryselector">
            <option value="全て">全て</option>
          </select>
        </div>
        <div id="graphDiv">
          <div class="chart-panel">
            <canvas id="chartCanvas"/>
          </div>
        </div>
        <h2>CSVダウンロード</h2>
        <div class="download">
          <button class="button" id="csv_observatory">選択した観測所</button>
          <button class="button" id="csv_maparea">マップ表示のみ</button>
          <a id="download_link" href="#" download="test.txt" style="display: none">ダウンロード</a>
        </div>
      </div>
      <div id="viewDiv"></div>
    </div>
  </body>
</html>
  
  
      <script id="rendered-js" >
var map = null;
var view = null;
var legend = null;
var current_field = null;
var left_layer = null;
var graphicsLayer = null;
var chart = null;

var default_extend = {
  xmin: 126.2331,
  ymin: 31.367,
  xmax: 151.5675,
  ymax: 44.3821
}

require([
  "esri/Map",
  "esri/WebMap",
  "esri/views/MapView",
  "esri/layers/TileLayer",
  "esri/layers/FeatureLayer",
  "esri/layers/GraphicsLayer",
  "esri/widgets/Home",
  "esri/widgets/Swipe",
  "esri/widgets/Legend",
  "esri/widgets/Expand",
  "esri/widgets/BasemapGallery",
  "esri/widgets/Slider",
  "esri/geometry/Extent",
  "esri/renderers/Renderer"
], function (Map, WebMap, MapView, TileLayer, FeatureLayer, GraphicsLayer, 
              Home, Swipe, Legend, Expand, BasemapGallery, Slider, Extent, Renderer) {
  map = new WebMap({
    portalItem: {
      id: "f2e62fc62b3d4bedb874d25cf443c776"
    }
  });

  view = new MapView({
    container: "viewDiv",
    map: map,
    zoom: 14,
    constraints: {
      minScale : 50000000,
      maxScale : 5000
    }
  });

  const prefectures = new FeatureLayer({
    portalItem: {
      id: "bf1517e6867c416d817a46d0b444dc5f"
    }
  });

  var shihyoLayer = null;

  var homeBtn = new Home({
    view: view
  });
  view.ui.add(homeBtn, "top-left");

  var basemapGallery = new BasemapGallery({
    view: view,
    container: document.createElement("div")
  });

  var bgExpand = new Expand({
    view: view,
    content: basemapGallery
  });

  basemapGallery.watch("activeBasemap", function () {
    var mobileSize =
        view.heightBreakpoint === "xsmall" ||
        view.widthBreakpoint === "xsmall";

    if (mobileSize) {
      bgExpand.collapse();
    }
  });
  view.ui.add(bgExpand, "top-right");

  var legend = new Legend({
    view: view
  });

  var lgExpand = new Expand({
    view: view,
    content: legend,
    expanded: true,
    mode : "floating"
  });

  view.ui.add(lgExpand, "bottom-right");

  var yearSlider = new Slider({
    container: "yearselector",
    steps: 1,
    labelInputsEnabled: true,
    labelFormatFunction: function(value, type){
      return value + "年";
    },
    values: [ 2019 ],
    visibleElements: {
      labels: true,
      rangeLabels: true
    }
  });

  view.when(function() {
    setForm(true);
    setFilter(false);
    draw_charts();
  });

  view.popup.on("trigger-action", function(event){
    var observatory = view.popup.selectedFeature.attributes['観測地点名'];
    draw_charts(observatory);
  });


  view.extent = default_extend;


  //イベント処理
  $('#bunruiselector').change(function() {
    setForm(true);
    setFilter(true);
    draw_charts();
  })

  $('#shihyoselector').change(function() {
    setForm(false);
    setFilter(true);
    draw_charts();
  })

  $('#monthshihyoselector').change(function() {
    setFilter(true);
  })

  $('#prefectureselector').change(function() {
    setObservatoryselector();
    setForm(false);
    setFilter(true);
    draw_charts();
  })

  $('#observatoryselector').change(function() {
    setForm(false);
    setFilter(true);
    draw_charts();
  })

  yearSlider.on("thumb-change", function(event) {
    setFilter(false);
  });
  yearSlider.on("thumb-drag", function(event) {
    setFilter(false);
  });
  
  $('#monthselector').change(function() {
    setForm(false);
    setFilter(false);
    draw_charts();
  })
  
  $('#csv_observatory').click(function() {
    download_csv(0);
  })
    
  $('#csv_maparea').click(function() {
    download_csv(1);
  })
  

  function setForm(init_flg){
    var bunrui = $('#bunruiselector').val();
    var shihyo = $('#shihyoselector').val();
    var month =  $('#monthselector').val();

    if (bunrui == "年間値") {
      $('#monthselectorDiv').addClass('hidden');
    } else {
      $('#monthselectorDiv').removeClass('hidden');
    }

    if (init_flg) {
      $('#shihyoselector > option').remove();

      if (bunrui == "年間値") {
        $('#shihyoselector').append($('<option>').html("年平均気温(℃)").val("年平均気温"));
        $('#shihyoselector').append($('<option>').html("日最高気温の年平均(℃)").val("日最高気温の年平均"));
        $('#shihyoselector').append($('<option>').html("日最低気温の年平均(℃)").val("日最低気温の年平均"));
        $('#shihyoselector').append($('<option>').html("猛暑日（日最高気温35℃以上）の年間日数(日)").val("猛暑日の年間日数"));
        $('#shihyoselector').append($('<option>').html("真夏日（日最高気温30℃以上）の年間日数(日)").val("真夏日の年間日数"));
        $('#shihyoselector').append($('<option>').html("夏日（日最高気温25℃以上）の年間日数(日)").val("夏日の年間日数"));
        $('#shihyoselector').append($('<option>').html("熱帯夜（日最低気温25℃以上）の年間日数(日)").val("熱帯夜の年間日数"));
        $('#shihyoselector').append($('<option>').html("冬日（日最低気温0℃以下）の年間日数(日)").val("冬日の年間日数"));
        $('#shihyoselector').append($('<option>').html("真冬日（日最高気温0℃以下）の年間日数(日)").val("真冬日の年間日数"));
        $('#shihyoselector').append($('<option>').html("年降水量(mm)").val("年降水量"));
        $('#shihyoselector').append($('<option>').html("日降水量の年最大値(mm)").val("日降水量の年最大値"));
        $('#shihyoselector').append($('<option>').html("日降水量100mm以上の年間日数(日)").val("日降水量100mm以上の年間日数"));
        $('#shihyoselector').append($('<option>').html("日降水量200mm以上の年間日数(日)").val("日降水量200mm以上の年間日数"));
        $('#shihyoselector').append($('<option>').html("1時間降水量30mm以上の年間発生回数(回)").val("1時間降水量30mm以上の年間発生回数"));
        $('#shihyoselector').append($('<option>').html("1時間降水量50mm以上の年間発生回数(回)").val("1時間降水量50mm以上の年間発生回数"));
        $('#shihyoselector').append($('<option>').html("無降水日年間日数(日)").val("無降水日年間日数"));
        $('#shihyoselector').append($('<option>').html("年最大積雪深(cm)").val("年最大積雪深"));
        $('#shihyoselector').append($('<option>').html("日降雪量の年最大値(cm)").val("日降雪量の年最大値"));

        
      } else {
        $('#shihyoselector').append($('<option>').html("月平均気温(℃)").val("月平均気温"));
        $('#shihyoselector').append($('<option>').html("日最高気温の月平均(℃)").val("日最高気温の月平均"));
        $('#shihyoselector').append($('<option>').html("日最低気温の月平均(℃)").val("日最低気温の月平均"));
        $('#shihyoselector').append($('<option>').html("月降水量(mm)").val("月降水量"));
        $('#shihyoselector').append($('<option>').html("月最大積雪深(cm)").val("月最大積雪深"));
      }
      
      if (init_flg) {
        $('#shihyoselector').prop("selectedIndex", 0);
        shihyo = $('#shihyoselector').val();
      }
    }
    
    //レイヤーの初期化
    var layers = map.allLayers.items;
    for(let i = 0; i < layers.length; i++) {
      if (layers[i].type != "feature") {
        continue;
      }

      if (layers[i].title == shihyo) {
        shihyoLayer = layers[i];
        
        shihyoLayer.popupTemplate.actions = [{
          title: "ｸﾞﾗﾌ表示",
          id: "change-chart",
          image: "https://illustration-free.net/thumb/svg/ifn0397.svg"
        }];
        
        legend.layerInfos.layer = shihyoLayer;

        layers[i].visible = true;
      } else {
        layers[i].visible = false;
      }
    }
    
    
    var prefecture = $('#prefectureselector').val();
    var observatory =  $('#observatoryselector').val();

    let query = shihyoLayer.createQuery();

    var expression = "";
    if (bunrui == "月別値") { 
      expression = " AND 月 = " + month;
    }
    
    if (observatory != "全て"){
      query.where = " 観測地点名 = '" + observatory + "'" + expression;
    } else if (prefecture != "全国") {
      query.where = " 都道府県 = '" + prefecture + "'" + expression;
    } else {
      query.where = " 1=1" + expression;
    }
    
    query.outFields = [
      "年"
    ];

    query.outStatistics = [
      {
        statisticType: "min",
        onStatisticField: "年",
        outStatisticFieldName: "最小年"
      },
      {
        statisticType: "max",
        onStatisticField: "年",
        outStatisticFieldName: "最大年"
      }  
    ];
    query.returnGeometry = false;

    shihyoLayer.queryFeatures(query)
      .then(function(response){
      
      var features = response.features;
      var min_year = features[0].attributes["最小年"];
      var max_year = features[0].attributes["最大年"];
      
      yearSlider.min = min_year;
      yearSlider.max = max_year;
      
    });
    
    if (!init_flg) {
      return;
    }
    
    query = shihyoLayer.createQuery();

    var expression = "1 = 1";
    if (bunrui == "月別値") { 
      expression = "月 = " + month;
    }
    
    query.where = expression;
    query.outFields = [
      "都道府県"
    ];
    query.orderByFields = "地点番号";
    query.groupByFieldsForStatistics = "都道府県";

    query.outStatistics = [
      {
        statisticType: "min",
        onStatisticField: "都道府県",
        outStatisticFieldName: "都道府県リスト"
      },
      {
        statisticType: "min",
        onStatisticField: "地点番号",
        outStatisticFieldName: "地点番号"
      }  
    ];
    query.returnGeometry = false;

    shihyoLayer.queryFeatures(query)
      .then(function(response){
      var features = response.features;
      var recordes = [];
      $('#prefectureselector > option').remove();
      $('#prefectureselector').append($('<option>').html("全国").val("全国"));

      for(var i = 0; i< features.length; i++) {
        var area = features[i].attributes["都道府県リスト"];
        $('#prefectureselector').append($('<option>').html(area).val(area));

      }
      $('#prefectureselector').prop("selectedIndex", 0);
      setObservatoryselector(init_flg);
      
    });
  }

  function setObservatoryselector(init_flg) {

    var prefecture = $('#prefectureselector').val();
    var bunrui = $('#bunruiselector').val();
    var month =  $('#monthselector').val();
    
    let query = shihyoLayer.createQuery();

    var expression = "1 = 1";
    if (bunrui == "月別値") { 
      expression = "月 = " + month;
    }
    
    if (prefecture == "全国") {
      query.where = expression;
    } else {
      query.where = expression + " AND 都道府県= '" + prefecture + "'";
    }

    query.outFields = [
      "都道府県", "地点番号", "観測地点名"
    ];
    query.orderByFields = "地点番号";
    query.groupByFieldsForStatistics = ["地点番号", "観測地点名"];

    query.outStatistics = [
      {
        statisticType: "min",
        onStatisticField: "都道府県",
        outStatisticFieldName: "都道府県リスト"
      },
      {
        statisticType: "min",
        onStatisticField: "観測地点名",
        outStatisticFieldName: "観測地点名リスト"
      }  
    ];
    query.returnGeometry = false;

    $('#observatoryselector > option').remove();
    $('#observatoryselector').append($('<option>').html("全て").val("全て"));
    if (init_flg) {
      $('#observatoryselector').prop("selectedIndex", 0);
    }
    shihyoLayer.queryFeatures(query)
      .then(function(response){
      var features = response.features;
      var recordes = [];


      for(var i = 0; i< features.length; i++) {
        var area = features[i].attributes["観測地点名リスト"];
        $('#observatoryselector').append($('<option>').html(area).val(area));

      }
    });
  }

  function setFilter(zoom_flg) {

    var bunrui = $('#bunruiselector').val();
    var prefecture = $('#prefectureselector').val();
    var observatory =  $('#observatoryselector').val();
    var year = yearSlider.values[0];
    var month =  $('#monthselector').val();

    shihyoLayer.definitionExpression = "";
    
    var expression = "年 = " + String(year);
    
    if (bunrui == "月別値") { 
      expression = expression + " AND 月 = " + month;
    }
    
    if (observatory != "全て"){
      shihyoLayer.definitionExpression = expression + " AND 観測地点名 = '" + observatory + "'";
      
      if (zoom_flg){
        zoomToLayer();
      }
    } else if (prefecture != "全国") {
      shihyoLayer.definitionExpression = expression + " AND 都道府県 = '" + prefecture + "'";
      if (zoom_flg){
        zoomToLayer();
      }
    } else {
      shihyoLayer.definitionExpression = expression;
      if (zoom_flg){
        view.extent = default_extend;
      }
    }


    function zoomToLayer() {
      return shihyoLayer.queryExtent().then(function(response) {
        view.goTo(response.extent.clone().expand(1.2))
          .catch(function(error){
          if (error.name != "AbortError"){
            console.error(error);
          }
        });
      });
    }
  }
  
  function draw_charts(observatory) {

    var bunrui = $('#bunruiselector').val();
    var shihyo = $('#shihyoselector').val();
    var shihyotxt = $('#shihyoselector option:selected').text();
    var prefecture = $('#prefectureselector').val();
    
    if (observatory == undefined) {
      observatory =  $('#observatoryselector').val();
    }
    
    var month =  $('#monthselector').val();
    var monthtxt = $('#monthselector option:selected').text();

    //1時間で始まる指標には先頭にFをつける
    var regex = new RegExp(/^1.*$/);
    if (regex.test(shihyo)) {
      shihyo = "F" + shihyo;
    }

    //グラフ作成
    let query = shihyoLayer.createQuery();
    query.outFields = [
      "年", shihyo
    ];
    query.orderByFields = "年";
    query.groupByFieldsForStatistics = "年";

    query.outStatistics = [
      {
        statisticType: "avg",
        onStatisticField: shihyo,
        outStatisticFieldName: "value"
      }  
    ];
    query.returnGeometry = false;
    
    var chat_title = shihyotxt + " ";
    
    var expression = shihyo + " <> " + String(32767);
    if (bunrui == "月別値") { 
      chat_title = chat_title + monthtxt + " ";
      expression = expression + " AND 月 = " + month;
    }
    
    if (observatory != "全て"){
      query.where = expression + " AND 観測地点名 = '" + observatory + "'";
      chat_title = chat_title + observatory + "観測所";
    } else if (prefecture != "全国") {
      query.where = expression + " AND 都道府県 = '" + prefecture + "'";
      chat_title = chat_title + prefecture + "平均";
    } else {
      query.where = expression;
      chat_title = chat_title + "全国平均";
    }
    
    shihyoLayer.queryFeatures(query)
      .then(function(response){ 
      var features = response.features;
      var labels = [];
      var datas = [];
      for(var i = 0; i< features.length; i++) {
        var year = features[i].attributes["年"];
        var value = features[i].attributes["value"];
        
        labels.push(year);
        datas.push(Math.round(value * 100) / 100);
      }
      
      update_chart(chat_title, labels, datas);
    });
  }

  function update_chart(chat_title, labels, datas){

    var ctx = document.getElementById("chartCanvas").getContext('2d');

    if (chart != null) {
      chart.destroy();
    }

    var bunrui = $('#bunruiselector').val();
    var shihyo = $('#shihyoselector').val();
    var prefecture = $('#prefectureselector').val();
    var observatory =  $('#observatoryselector').val();
    var month =  $('#monthselector').val();

    var datasets = [];

    datasets.push({
      data: datas,
      borderColor: "rgba(0,169,255,1)",
      lineTension: 0,
      fill: false
    });

    

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: datasets
      },
      options: {
        title: {
          display: true,
          text: chat_title
        },
        layout: {
          padding: {
            left: 0,
            right: 0,
            top: 0
          }
        },
        legend: {
          display: false,
          position: 'right',
          labels: {
            boxWidth: 20,
            usePointStyle: true,
            padding: 10
          }
        },
        scales: {
          xAxes: [{
            ticks: {
              beginAtZero: true,
              stepSize: 1,
              callback: function(value, index, values){
                return  value
              }
            }
          }],
          yAxes: [{
            ticks: {
              beginAtZero: true,
              userCallback: function(label, index, labels) {
                if (Math.floor(label) === label) {
                  return label;
                }
              }
            }
          }]
        },
        responsive: true,
        maintainAspectRatio: false

      }
    });
  }
  

  function download_csv(flg) {
    
    var bunrui = $('#bunruiselector').val();
    var shihyo = $('#shihyoselector').val();
    var shihyotxt = $('#shihyoselector option:selected').text();
    
    var prefecture = $('#prefectureselector').val();
    var observatory =  $('#observatoryselector').val();
    
    var year = yearSlider.values[0];
    var month =  $('#monthselector').val();


    //1時間で始まる指標には先頭にFをつける
    var regex = new RegExp(/^1.*$/);
    if (regex.test(shihyo)) {
      shihyo = "F" + shihyo;
    }
    
    var fields = ["地点番号", "都道府県", "観測地点名", "緯度", "経度", "年", shihyo];
    
    if (bunrui == "月別値") {
      fields = ["地点番号", "都道府県", "観測地点名", "緯度", "経度", "年", "月", shihyo];
    }
    
    var query = shihyoLayer.createQuery();

    var expression = "年 = " + year;
    if (bunrui == "月別値") {
      expression = "年 = " + year + " AND 月 = " + month;
    }
    
    if (flg == 0) {
      if (observatory != "全て"){
        query.where = expression + " AND 観測地点名 = '" + observatory + "'";
        shihyotxt = shihyotxt + "_" + observatory;
      } else if (prefecture != "全国") {
        query.where = expression + " AND 都道府県 = '" + prefecture + "'";
        shihyotxt = shihyotxt + "_" + prefecture;
      } else {
        query.where = expression;
        shihyotxt = shihyotxt + "_全国";
      }
    } else {
      
      query.geometry = view.extent;
      shihyotxt = shihyotxt + "_マップ範囲";
    }
    
    query.outFields = fields;
    
    query.orderByFields = "地点番号,年";
    if (bunrui == "月別値") {
      query.orderByFields = "地点番号,年,月";
    }
    
    query.returnGeometry = false;
    query.maxRecordCountFactor = 10;

    var records = [];
    
    shihyoLayer.queryFeatures(query)
      .then(function(response){
      var features = response.features;

      for (let i = 0; i < features.length; ++i) {
        var att = features[i].attributes;
        
        var record = [];
        for (let j = 0; j < fields.length; ++j) {
          record.push(att[fields[j]]);
        }
        records.push(record);
      }
      
      startDownload(shihyotxt, fields, records);
    });


    function startDownload(shihyo, fields, records) {
      const filename = "アメダス_" + shihyo + '.csv';
      
      var csv_text = fields.join(',') + "\r\n";
      
      for (let i = 0; i < records.length; ++i) {
        for (let j = 0; j < records[i].length; ++j) {
          csv_text = csv_text + records[i][j] + ",";
        }
        csv_text = csv_text + "\r\n";
      }
      
      //BOMを付与する（Excelでの文字化け対策）
      const bom = new Uint8Array([0xef, 0xbb, 0xbf]);
      //Blobでデータを作成する
      const blob = new Blob([bom, csv_text], { type: 'text/csv'});

      //IE10/11用
      if (window.navigator.msSaveBlob) {
        window.navigator.msSaveBlob(blob, filename);
        //その他ブラウザ
      } else {
        const url = (window.URL || window.webkitURL).createObjectURL(blob);
        const download = document.createElement('a');
        download.href = url;
        download.download = filename;
        download.click();
        (window.URL || window.webkitURL).revokeObjectURL(url);
      }
    }
  }
});
    </script>

  

</body>

</html>
 
